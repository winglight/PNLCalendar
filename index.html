<!DOCTYPE html>
<html lang="en">
<!-- 在head部分添加或修改viewport元数据 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Calendar</title>
    <link rel="stylesheet" href="r2-config.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.ico">
</head>
<body>
    <a href="https://github.com/winglight/PNLCalendar" class="github-link" target="_blank">
        <svg height="32" viewBox="0 0 16 16" width="32">
            <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
    </a>
    <div class="toolbar">
        <div class="toolbar-left">
            <button id="showLogSidebarBtn" class="log-sidebar-btn">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path d="M18,2A2,2 0 0,1 20,4V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2H18M18,4H6V20H18V4M15.5,17H8.5V15.5H15.5V17M15.5,9.5H8.5V8H15.5V9.5M15.5,13.25H8.5V11.75H15.5V13.25Z"/>
                </svg>
                日志
            </button>
            <div class="date-picker-container">
                <button  id="showDateRangeBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                    </svg>
                    Date range
                </button>
                
                <div id="dateRangePicker" class="date-range-picker">
                    <div class="date-range">
                        <div class="date-picker-group">
                            <span>Start Date</span>
                            <input type="date" id="startDate">
                            <span>→</span>
                            <span>End Date</span>
                            <input type="date" id="endDate">
                            <button id="applyDateRange" class="go-button">Go</button>
                        </div>
                        <div class="preset-dates">
                            <button data-range="today">Today</button>
                            <button data-range="thisWeek">This Week</button>
                            <button data-range="thisMonth">This Month</button>
                            <button data-range="last30Days">Last 30 Days</button>
                            <button data-range="lastMonth">Last Month</button>
                            <button data-range="thisQuarter">This Quarter</button>
                            <button data-range="ytd">YTD</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="symbol-filter-container">
                <div class="combobox-wrapper">
                    <input type="text" id="symbolFilter" class="symbol-input" placeholder="Filter by Symbol">
                    <button class="dropdown-toggle" id="symbolDropdownBtn">
                        <svg width="10" height="10" viewBox="0 0 10 10">
                            <path d="M1 3L5 7L9 3" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                </div>
                <div id="symbolDropdown" class="symbol-dropdown"></div>
            </div>
        </div>
        
        <div class="toolbar-right">
            <button id="showImportModalBtn">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Import IB Data
            </button>
            <button id="configR2Btn">Configure R2</button>
        </div>
    </div>    

<!-- 导入弹窗 -->
<div id="importModal" class="import-modal">
    <div class="import-modal-content">
        <h2>Import Trades</h2>
        <p>Auto import your trades from your broker or platform.</p>
        <form id="handleImportForm" class="import-form">
            <div class="form-group">
                <label>Broker</label>
                <select class="broker-select">
                    <option value="ib">Interactive Brokers</option>
                </select>
            </div>
            <div class="form-group">
                <label>Flex Token <span style="color: red;">required</span></label>
                <input type="text" id="flexToken" required>
            </div>
            <div class="form-group">
                <label>Report Id <span style="color: red;">required</span></label>
                <input type="text" id="reportId" required>
            </div>
            <div class="form-group">
                <a target="_blank" href="https://intercom.help/tradezella-4066d388d93c/en/articles/6063403-interactive-broker-how-to-sync-your-interactive-broker-ibkr-account-with-tradezella">
                <label>How to get Token and Id</label>
                </a>
            </div>
            <button type="submit" class="connect-button">Connect</button>
        </form>
    </div>
</div>    
<div class="container">
    <!-- <div class="file-controls">
        <input type="file" id="csvFile" accept=".csv" class="file-input">
        <button onclick="clearData()">Clear Data</button>
    </div> -->
    <div class="header">
        <div class="month-navigation">
            <button data-direction=-1>←</button>
            <h2 id="currentMonth"></h2>
            <button data-direction=1>→</button>
        </div>
        <div class="month-stats">
            <span>Monthly stats:</span>
            <span id="monthlyPnL"></span>
            <span id="tradingDays"></span>
        </div>
    </div>
    <div class="calendar" id="calendar"></div>
</div>
<!-- 添加交易详情弹窗 -->
<div id="tradeModal" class="trade-modal">
    <div class="trade-modal-content">
        <div class="modal-header">
            <h2 id="modalDate"></h2>
            <h2 id="modalNetPnL"></h2>
        </div>
        <div class="trade-stats">
            <div>
                <span>Total Trades: </span><span id="modalTotalTrades"></span>
                <span>Winners: </span><span id="modalWinners"></span>
                <span>Winrate: </span><span id="modalWinrate"></span>
            </div>
            <div>
                <span>Losers: </span><span id="modalLosers"></span>
                <span>Volume: </span><span id="modalVolume"></span>
                <span>Profit Factor: </span><span id="modalProfitFactor"></span>
            </div>
        </div>
        <table class="trades-table">
            <thead>
                <tr>
                    <th>Open Time</th>
                    <th>Ticker</th>
                    <th>Side</th>
                    <th>Instrument</th>
                    <th>Net P&L</th>
                    <th>Net ROI</th>
                    <th>Trade Times</th>
                    <th>Playbook</th>
                </tr>
            </thead>
            <tbody id="tradesTableBody">
            </tbody>
        </table>
        <div class="button-group">
            <button class="cancel-button" id="closeTradeModalBtn">Cancel</button>
            <button class="details-button" id="viewDetailsBtn">View Details</button>
        </div>
    </div>
</div>
<div class="stats-container">
    <!-- 统计指标卡片行 -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-header">
                <span>Net P&L</span>
                <div class="header-controls">
                    <span class="trade-count">95</span>
                    <span class="fullscreen-btn" data-card="net-pnl">⛶</span>
                </div>
            </div>
            <div class="stat-value positive">$16,574.07</div>
        </div>
        
        <div class="stat-card" id="win-rate">
            <div class="stat-header">
                <span>Trade Win %</span>
                <div class="header-controls">
                    <span class="info-icon">ⓘ</span>
                    <span class="fullscreen-btn" data-card="win-rate">⛶</span>
                </div>
            </div>
            <div class="stat-value">77.89%</div>
            <div class="stat-gauge">
                <div class="win">74</div>
                <div class="neutral">0</div>
                <div class="loss">21</div>
            </div>
        </div>
        
        <div class="stat-card" id="profit-factor">
            <div class="stat-header">
                <span>Profit Factor</span>
                <div class="header-controls">
                    <span class="info-icon">ⓘ</span>
                    <span class="fullscreen-btn" data-card="profit-factor">⛶</span>
                </div>
            </div>
            <div class="stat-value">1.47</div>
            <div class="profit-ring"></div>
        </div>
        
        <div class="stat-card" id="day-win-rate">
            <div class="stat-header">
                <span>Day Win %</span>
                <div class="header-controls">
                    <span class="info-icon">ⓘ</span>
                    <span class="fullscreen-btn" data-card="day-win-rate">⛶</span>
                </div>
            </div>
            <div class="stat-value">67.27%</div>
            <div class="stat-gauge">
                <div class="win">37</div>
                <div class="neutral">12</div>
                <div class="loss">18</div>
            </div>
        </div>
        <div class="stat-card" id="avg-win-loss">
            <div class="stat-header">
                <span>Avg win/loss trade</span>
                <div class="header-controls">
                    <span class="info-icon">ⓘ</span>
                    <span class="fullscreen-btn" data-card="avg-win-loss">⛶</span>
                </div>
            </div>
            <div class="stat-value">67.27%</div>
            <div class="stat-gauge">
                <div class="win">37</div>
                <div class="loss">18</div>
            </div>
        </div>
    </div>

    <!-- 图表行 -->
    <div class="charts-section">
        <div class="chart-container" style="width:100%; max-width:100%;">
            <div class="chart-header">
                <h3>Daily Net Cumulative P&L</h3>
                <span class="fullscreen-btn" data-chart="cumulativePnLChart">⛶</span>
            </div>
            <div class="chart-wrapper">
                <canvas id="cumulativePnLChart"></canvas>
            </div>
        </div>
        <div class="chart-container" style="width:100%; max-width:100%;">
            <div class="chart-header">
                <h3>Net Daily P&L</h3>
                <span class="fullscreen-btn" data-chart="dailyPnLChart">⛶</span>
            </div>
            <div class="chart-wrapper">
                <canvas id="dailyPnLChart"></canvas>
            </div>
        </div>
    </div>
    <div class="charts-container">
        <div class="chart-item">
            <div class="chart-header">
                <h3>Trade Duration Performance</h3>
                <span class="fullscreen-btn" data-chart="durationPerformanceChart">⛶</span>
            </div>
            <canvas id="durationPerformanceChart"></canvas>
        </div>
        <div class="chart-item">
            <div class="chart-header">
                <h3>Trade Time Performance</h3>
                <span class="fullscreen-btn" data-chart="timePerformanceChart">⛶</span>
            </div>
            <canvas id="timePerformanceChart"></canvas>
        </div>
        <div class="chart-item">
            <div class="chart-header">
                <h3>Drawdown</h3>
                <span class="fullscreen-btn" data-chart="drawdownChart">⛶</span>
            </div>
            <canvas id="drawdownChart"></canvas>
        </div>
        <div class="chart-item stock-stats-container">
            <div class="chart-header">
                <h3>Stock Statistics</h3>
                <span class="fullscreen-btn" data-chart="stockStats">⛶</span>
            </div>
            <div class="stats-section">
                <h4>Top Profitable Stocks</h4>
                <table class="stock-stats-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Profit</th>
                            <th>Loss</th>
                            <th>Trades</th>
                        </tr>
                    </thead>
                    <tbody id="topProfitableStocks">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="stats-section">
                <h4>Most Loss Stocks</h4>
                <table class="stock-stats-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Profit</th>
                            <th>Loss</th>
                            <th>Trades</th>
                        </tr>
                    </thead>
                    <tbody id="topLossStocks">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="charts-section">
        <div class="chart-item">
            <div class="chart-header">
                <h3>Weekly Statistics</h3>
                <span class="fullscreen-btn" data-chart="weeklyStatsChart">⛶</span>
            </div>
            <canvas id="weeklyStatsChart"></canvas>
        </div>
        <div class="chart-item">
            <div class="chart-header">
                <h3>Weekly Win/Loss Trade Analysis</h3>
                <span class="fullscreen-btn" data-chart="weeklyTradeAnalysisChart">⛶</span>
            </div>
            <canvas id="weeklyTradeAnalysisChart"></canvas>
        </div>
    </div>
</div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="r2-sync.js" type="module"></script>
<script src="main.js" type="module"></script>

    <!-- 添加统计卡片全屏模态框 -->
    <div id="statModal" class="stat-modal">
        <div class="stat-modal-content">
            <button class="close-button">&times;</button>
            <h2 id="statModalTitle"></h2>
            <div id="statModalContent"></div>
        </div>
    </div>

    <!-- 添加图表全屏模态框 -->
    <div id="chartModal" class="chart-modal">
        <div class="chart-modal-content">
            <button class="close-button">&times;</button>
            <h2 id="chartModalTitle"></h2>
            <div id="chartModalContent"></div>
        </div>
    </div>
    <!-- Log Entry Modal -->
    <div id="logModal" class="modal hidden">
      <div class="modal-content log-modal">
        <span class="close" id="closeLogModal">&times;</span>
        <h2 id="logModalTitle">复盘日志</h2>
        <form id="logForm">
          <div class="form-row">
            <label for="logDate">日期</label>
            <input type="date" id="logDate" name="date" required />
          </div>
            <div class="form-row">
              <label for="logType">类型</label>
              <select id="logType" name="type">
                <option value="daily">每日复盘</option>
                <option value="weekly">每周复盘</option>
              </select>
            </div>
            <div id="dailyFields" class="daily-fields">
              <div class="form-row two-cols">
                <div>
                  <label for="tradeCount">今天/本周做了几笔交易</label>
                  <input type="number" id="tradeCount" name="quickReview.count" min="0" />
                </div>
                <div>
                  <label for="feelScore">整体感觉如何（1-5）</label>
                  <input type="number" id="feelScore" name="quickReview.feel" min="1" max="5" />
                </div>
              </div>
              <div class="form-row">
                <label for="facts">记录事实</label>
                <textarea id="facts" name="facts" rows="4" placeholder="只写发生了什么，不带情绪"></textarea>
              </div>
              <div class="form-row">
                <label for="learnings">提炼学习点</label>
                <textarea id="learnings" name="learnings" rows="4" placeholder="从市场走势、操作、情绪管理中提炼1–2个收获"></textarea>
              </div>
              <div class="form-row">
                <label for="improvements">优化方向</label>
                <textarea id="improvements" name="improvements" rows="3" placeholder="下次可以改进的一个小动作"></textarea>
              </div>
              <div class="form-row">
                <label for="affirmations">自我肯定</label>
                <textarea id="affirmations" name="affirmations" rows="3" placeholder="哪怕亏钱，也找一条做得对的地方"></textarea>
              </div>
              <div class="form-row">
                <label for="linkedTrades">关联交易ID（逗号分隔，可选）</label>
                <input type="text" id="linkedTrades" name="linkedTradeIds" placeholder="例如：t123,t124" />
              </div>
            </div>
          
          <!-- 每周复盘专用字段 -->
          <div id="weeklyFields" class="weekly-fields hidden">
            <div class="form-section">
              <h3>1. 本周数据</h3>
              <div class="form-row readonly-row">
                <label>总交易笔数（自动计算）</label>
                <input type="number" id="weeklyTotalTrades" readonly />
              </div>
              <div class="form-row readonly-row">
                <label>盈亏结果（自动计算）</label>
                <input type="text" id="weeklyPnlResult" readonly />
              </div>
              <div class="form-row readonly-row">
                <label>最大单笔盈利/亏损（自动计算）</label>
                <input type="text" id="weeklyMaxWinLoss" readonly />
              </div>
              <div class="form-row readonly-row">
                <label>胜率（自动计算）</label>
                <input type="text" id="weeklyWinRate" readonly />
              </div>
              <div class="form-row readonly-row">
                <label>是否遵守"每日最多3笔交易"规则（自动计算）</label>
                <input type="text" id="weeklyDailyLimit" readonly />
              </div>
            </div>

            <div class="form-section">
              <h3>2. 成功经验</h3>
              <div class="form-row">
                <label for="plannedTrades">✅ 哪些交易符合计划，带来了预期结果？</label>
                <textarea id="plannedTrades" name="plannedTrades" rows="3" placeholder="描述符合计划的交易..."></textarea>
              </div>
              <div class="form-row">
                <label for="emotionalStability">✅ 哪些行为让我情绪稳定？</label>
                <textarea id="emotionalStability" name="emotionalStability" rows="3" placeholder="描述让你保持情绪稳定的行为..."></textarea>
              </div>
            </div>

            <div class="form-section">
              <h3>3. 失误总结</h3>
              <div class="form-row">
                <label for="violatedPlans">❌ 哪些交易违背了计划？（下拉框多选）</label>
                <select id="violatedPlans" name="violatedPlans" multiple>
                  <option value="超量交易">超量交易</option>
                  <option value="未设止损">未设止损</option>
                  <option value="追涨杀跌">追涨杀跌</option>
                  <option value="持仓过夜">持仓过夜</option>
                  <option value="违反策略">违反策略</option>
                  <option value="情绪化操作">情绪化操作</option>
                </select>
              </div>
              <div class="form-row">
                <label for="emotionalFactors">❌ 哪些情绪（贪婪/恐惧/犹豫）影响了操作？（下拉框多选）</label>
                <select id="emotionalFactors" name="emotionalFactors" multiple>
                  <option value="贪婪">贪婪</option>
                  <option value="恐惧">恐惧</option>
                  <option value="犹豫">犹豫</option>
                  <option value="焦虑">焦虑</option>
                  <option value="后悔">后悔</option>
                  <option value="兴奋">兴奋</option>
                </select>
              </div>
            </div>

            <div class="form-section">
              <h3>4. 下周优化</h3>
              <div class="form-row">
                <label for="goodHabitToKeep">🎯 我下周要保持的1个好习惯</label>
                <textarea id="goodHabitToKeep" name="goodHabitToKeep" rows="2" placeholder="例如：保持止损纪律"></textarea>
              </div>
              <div class="form-row">
                <label for="mistakeToAvoid">🚫 我下周要避免的1个错误</label>
                <textarea id="mistakeToAvoid" name="mistakeToAvoid" rows="2" placeholder="例如：避免追涨杀跌"></textarea>
              </div>
              <div class="form-row">
                <label for="specificActions">📝 具体执行动作</label>
                <textarea id="specificActions" name="specificActions" rows="3" placeholder="例如：开盘前写好计划，再下单"></textarea>
              </div>
            </div>

            <div class="form-section">
              <h3>5. 本周自我肯定</h3>
              <div class="form-row">
                <label for="weeklyAffirmation">🌟 本周最值得肯定的一件事</label>
                <textarea id="weeklyAffirmation" name="weeklyAffirmation" rows="3" placeholder="记录本周最值得肯定的事情..."></textarea>
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" id="deleteLogBtn" class="danger hidden">删除</button>
            <button type="submit" id="saveLogBtn" class="primary">保存</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Log Sidebar -->
    <aside id="logSidebar" class="log-sidebar hidden">
      <div class="log-sidebar-header">
        <h3>日志</h3>
        <button id="closeLogSidebar" class="icon-btn" title="关闭">×</button>
      </div>
      <div id="logSidebarList" class="log-list"></div>
      <div id="logSidebarLoading" class="log-loading hidden">加载中...</div>
    </aside>
</body>
</html>